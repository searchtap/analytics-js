version: 2

restore_cache_settings: &restore_cache_settings
  key: node-deps-{{ checksum "package.json" }}

save_cache_settings: &save_cache_settings
  key: node-deps-{{ checksum "package.json" }}
  paths:
    - node_modules

node-build: &node-build
  docker:
    - image: circleci/node:11

  steps:
    - run: sudo npm install -g typescript
    - checkout
    - restore_cache: *restore_cache_settings
    - run: yarn install
    - run: yarn test
    - save_cache: *save_cache_settings
    - run: mkdir -p shared
    - run: yarn build
    - run: cp -r lib config package.json yarn.lock .circleci .npmignore .gitignore .env.default .env.production webpack.config.js shared/
    - store_artifacts:
        path: shared

    - persist_to_workspace:
        root: shared
        paths:
          - ./

jobs:
  build: *node-build

  deploy_prod:
    docker:
      - image: circleci/node:11

    steps:

      - attach_workspace:
          at: shared

      - run: cp -r shared/. .

      - run:
          name: NPM Publish
          command: |
            npm publish --dryrun


workflows:
  version: 2
  ci:
    jobs:
      - build

      - deploy_prod:
          requires:
            - build
          filters:
            branches:
              only: circle-ci
